@startuml sd5_account_deletion
' Refers to UC5
hide footbox

participant "Mobile App" as app
participant "Account API Gateway" as aapi
participant "Account Deletion Service" as ads
participant "Authentication Service" as auth
participant "Credentials DBMS" as dbc
participant "Account Management Service" as acmngr
participant "Account DBMS" as dba
participant "Email Proxy Service" as emailp
actor "Email Service Provider" as email

activate app
app -> aapi : frw_delete_acc_req(userId, emailAddr)
activate aapi
aapi ->> ads : delete_acc_req(userId, emailAddr)
deactivate aapi
activate ads
ads ->> emailp : send_acc_del_link(emailAddr, delLink)
deactivate ads
activate emailp
emailp ->> email : send_email(emailAddr, delLinkMsg)
deactivate emailp

app -> aapi : frw_acc_del_conf(delToken) 
note right
    The user opens the link received by email, which 
    will be opened by the mobile app
end note
activate aapi
aapi ->> ads : acc_del_conf(delToken)
deactivate aapi
activate ads
break #ffe6e6 link expired
    ads -->> aapi : link_expired_error
    activate aapi
    aapi -->> app : link_expired_error
    deactivate aapi
end
par #e1f4fc
    ads ->> auth : delete_acc_cred(userId)
    deactivate ads
    activate auth
    auth ->> dbc : query_delete_acc(userId)
    deactivate auth
    activate dbc
    dbc -> dbc : delete_acc(userId)
    dbc -->> auth : done
    deactivate dbc
    activate auth
    auth -->> ads : done
    deactivate auth
    activate ads
else
    ads ->> acmngr : delete_acc(userId)
    deactivate ads
    activate acmngr
    acmngr ->> dba : query_delete_acc(userId)
    deactivate acmngr
    activate dba
    dba -> dba : delete_acc(userId)
    dba -->> acmngr : done
    deactivate dba
    activate acmngr
    acmngr -->> ads : done
    deactivate acmngr
    activate ads
end
ads -->> aapi : done
deactivate ads
activate aapi
aapi -->> app : done
deactivate aapi


/'
aapi ->> auth : delete_account(userId)
deactivate aapi
activate auth
auth ->> dbc : query_delete_acc(userId)
deactivate auth
activate dbc
dbc -> dbc : delete_acc(userId)
dbc -->> auth : delete_conf
deactivate dbc
activate auth
auth -->> aapi : delete_conf
deactivate auth
'/


@enduml