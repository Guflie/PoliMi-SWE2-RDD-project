@startuml uc4_sequence_diagram
hide footbox

actor "Registered User" as User
participant "BBP App" as App
participant "Email Service" as em

autonumber

activate User

User -> App : request_password_reset()
activate App
App -->> User : account_email_form()
deactivate App

User -> App : submit_email_address(email)
activate App
App -> App : validate_email_format()

break #ffe6e6 Invalid Email Format
    App -->> User : invalid_email_error()
end

App -> App : check_account_association()
    
break #ffe6e6 Email without account
    App -->> User : account_not_exists()
end

App ->> em : email_reset_password()
deactivate App
activate em
em -->> User : password_reset_email()
deactivate em

User -> App : open_reset_link()
activate App
App -> App : check_link_expiration()

break #ffe6e6 Link Expired (> 1 hour)
    App -->> User : link_expired_error()
end    
App -->> User : new_password_form()
deactivate App

User -> App : submit_new_password(new_pass)
activate App
App -> App : update_account_password()
App -->> User : password_update_ack()

deactivate App
deactivate User
@enduml